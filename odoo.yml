networks:
  traefik-net:
    external: true

services:
  web:
    networks:
    - traefik-net
    
    # Healthcheck para detectar mejor cuando está offline
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8069/web/health"] 
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      - "traefik.enable=true"

      # Router principal
      - "traefik.http.routers.odoo18-https.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`)"
      - "traefik.http.routers.odoo18-https.entrypoints=websecure"
      - "traefik.http.routers.odoo18-https.service=odoo18"
      - "traefik.http.routers.odoo18-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo18-https.middlewares=gzip,sslheader,limit"
      - "traefik.http.routers.odoo18-https.priority=50"

      # Router para websocket
      - "traefik.http.routers.odoo18-im-https.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`) && PathPrefix(`/websocket`)"
      - "traefik.http.routers.odoo18-im-https.entrypoints=websecure"
      - "traefik.http.routers.odoo18-im-https.service=odoo18-im"
      - "traefik.http.routers.odoo18-im-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo18-im-https.middlewares=gzip,sslheader,limit"
      - "traefik.http.routers.odoo18-im-https.priority=75"

      # Redirección de dominio staging
      - "traefik.http.routers.odoo-staging-redirect-https.rule=Host(`asoo-staging.indaws.cloud`)"
      - "traefik.http.routers.odoo-staging-redirect-https.entrypoints=websecure"
      - "traefik.http.routers.odoo-staging-redirect-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo-staging-redirect-https.service=odoo18"
      - "traefik.http.routers.odoo-staging-redirect-https.middlewares=staging-to-main-redirect"
      - "traefik.http.routers.odoo-staging-redirect-https.priority=200"

      # Services
      - "traefik.http.services.odoo18.loadbalancer.server.port=8069"
      - "traefik.http.services.odoo18-im.loadbalancer.server.port=8072"
      - "traefik.docker.network=traefik-net"

      # Middlewares
      - "traefik.http.middlewares.gzip.compress=true"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.limit.buffering.memRequestBodyBytes=20971520"
      - "traefik.http.middlewares.limit.buffering.maxRequestBodyBytes=20971520"
      - "traefik.http.middlewares.staging-to-main-redirect.redirectregex.regex=^https?://asoo-staging.indaws.cloud(.*)"
      - "traefik.http.middlewares.staging-to-main-redirect.redirectregex.replacement=https://asoo-finish-master-123.dev.indaws.cloud$${1}"
      - "traefik.http.middlewares.staging-to-main-redirect.redirectregex.permanent=true"