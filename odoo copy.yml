networks:
  traefik-net:
    external: true
services:
  web:
    networks:
    - traefik-net
    environment:
    - VIRTUAL_PORT=
    - VIRTUAL_HOST=
    - LETSENCRYPT_HOST=
    - LETSENCRYPT_EMAIL=
    labels:
      - "traefik.enable=true"

      # --- REDIRECCIÓN DE DOMINIO STAGING A PRINCIPAL ---
      # HTTP - Redirección de staging
      - "traefik.http.routers.odoo-staging-redirect-http.rule=Host(`asoo-staging.indaws.cloud`)"
      - "traefik.http.routers.odoo-staging-redirect-http.entrypoints=web"
      - "traefik.http.routers.odoo-staging-redirect-http.service=odoo18"
      - "traefik.http.routers.odoo-staging-redirect-http.middlewares=staging-to-main-redirect"
      - "traefik.http.routers.odoo-staging-redirect-http.priority=200"

      # HTTPS - Redirección de staging
      - "traefik.http.routers.odoo-staging-redirect-https.rule=Host(`asoo-staging.indaws.cloud`)"
      - "traefik.http.routers.odoo-staging-redirect-https.entrypoints=websecure"
      - "traefik.http.routers.odoo-staging-redirect-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo-staging-redirect-https.service=odoo18"
      - "traefik.http.routers.odoo-staging-redirect-https.middlewares=staging-to-main-redirect"
      - "traefik.http.routers.odoo-staging-redirect-https.priority=200"

      # --- CONFIGURACIÓN PRINCIPAL DE HTTP A HTTPS ---
      # El router HTTP ahora apunta explícitamente al servicio odoo18.
      # El middleware de redirección se aplica antes de que la petición llegue al servicio.
      - "traefik.http.routers.odoo18-http.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`)"
      - "traefik.http.routers.odoo18-http.entrypoints=web"
      - "traefik.http.routers.odoo18-http.service=odoo18"
      - "traefik.http.routers.odoo18-http.middlewares=odoo18-redirect"

      # --- ROUTER PRINCIPAL DE HTTPS (PARA TODO EL TRÁFICO GENERAL) ---
      - "traefik.http.routers.odoo18-https.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`) && !PathPrefix(`/web/database`) && !PathPrefix(`/website/info`) && !PathPrefix(`/websocket`)"
      - "traefik.http.routers.odoo18-https.entrypoints=websecure"
      - "traefik.http.routers.odoo18-https.service=odoo18"
      - "traefik.http.routers.odoo18-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo18-https.middlewares=gzip,sslheader,limit"
      - "traefik.http.routers.odoo18-https.priority=50"

      # --- ROUTER ESPECÍFICO PARA LAS RUTAS RESTRINGIDAS ---
      - "traefik.http.routers.odoo-restricted-database.entrypoints=websecure"
      - "traefik.http.routers.odoo-restricted-database.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`) && PathPrefix(`/web/database/`)"
      - "traefik.http.routers.odoo-restricted-database.tls=true"
      - "traefik.http.routers.odoo-restricted-database.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo-restricted-database.service=odoo18"
      - "traefik.http.routers.odoo-restricted-database.middlewares=odoo-ip-whitelist,gzip,sslheader,limit"
      - "traefik.http.routers.odoo-restricted-database.priority=100"

      # --- ROUTER PARA RUTAS DE WEBSITE INFO (SIN RESTRICCIÓN DE IP) ---
      - "traefik.http.routers.odoo18-website-info-https.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`) && PathPrefix(`/website/info`)"
      - "traefik.http.routers.odoo18-website-info-https.entrypoints=websecure"
      - "traefik.http.routers.odoo18-website-info-https.service=odoo18"
      - "traefik.http.routers.odoo18-website-info-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo18-website-info-https.middlewares=gzip,sslheader,limit"
      - "traefik.http.routers.odoo18-website-info-https.priority=75"

      # --- ROUTER PARA RUTAS DE WEBSOCKET (SIN RESTRICCIÓN DE IP) ---
      - "traefik.http.routers.odoo18-im-https.rule=Host(`asoo-finish-master-123.dev.indaws.cloud`) && PathPrefix(`/websocket`)"
      - "traefik.http.routers.odoo18-im-https.entrypoints=websecure"
      - "traefik.http.routers.odoo18-im-https.service=odoo18-im"
      - "traefik.http.routers.odoo18-im-https.tls.certresolver=myresolver"
      - "traefik.http.routers.odoo18-im-https.middlewares=gzip,sslheader,limit"
      - "traefik.http.routers.odoo18-im-https.priority=75"

      #====================================================== services ===========================================================
      - "traefik.http.services.odoo18.loadbalancer.server.port=8069"
      - "traefik.http.services.odoo18-im.loadbalancer.server.port=8072"
      - "traefik.docker.network=traefik-net"

      #===================================================== middlewares =========================================================
      - "traefik.http.middlewares.odoo18-redirect.redirectscheme.scheme=https"
      - "traefik.http.middlewares.odoo18-redirect.redirectscheme.permanent=true"
      - "traefik.http.middlewares.gzip.compress=true"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.limit.buffering.memRequestBodyBytes=20971520"
      - "traefik.http.middlewares.limit.buffering.maxRequestBodyBytes=20971520"
      - "traefik.http.middlewares.odoo-ip-whitelist.ipallowlist.sourcerange=194.30.4.97/32"

      # --- MIDDLEWARE DE REDIRECCIÓN DE DOMINIO ---
      - "traefik.http.middlewares.staging-to-main-redirect.redirectregex.regex=^https?://asoo-staging.indaws.cloud(.*)"
      - "traefik.http.middlewares.staging-to-main-redirect.redirectregex.replacement=https://asoo-finish-master-123.dev.indaws.cloud$${1}"
      - "traefik.http.middlewares.staging-to-main-redirect.redirectregex.permanent=true"
